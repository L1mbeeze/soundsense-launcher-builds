<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ad-Jukebox — Демонстрация</title>
    <style>
      :root {
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: #000;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        display: grid;
        place-items: center;
        font-family: "Segoe UI", sans-serif;
        color: #cbd5e1;
      }

      .video-stage {
        position: relative;
        width: 100%;
        height: 100%;
        background: #000;
        display: grid;
        place-items: center;
        overflow: hidden;
      }

      video {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: auto;
        height: auto;
        max-width: none;
        max-height: none;
        object-fit: fill;
        object-position: center;
        background: #000;
        display: none;
      }

      #image {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: auto;
        height: auto;
        max-width: none;
        max-height: none;
        object-fit: fill;
        object-position: center;
        display: none;
      }

      #idle-video,
      #idle-image {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: auto;
        height: auto;
        max-width: none;
        max-height: none;
        object-fit: fill;
        object-position: center;
        display: none;
      }

      .placeholder {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        font-size: 20px;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: rgba(255, 255, 255, 0.5);
        background:
          radial-gradient(circle at 20% 20%, rgba(0, 255, 166, 0.18), transparent 60%),
          radial-gradient(circle at 80% 10%, rgba(76, 201, 240, 0.15), transparent 50%),
          #000;
      }

    </style>
  </head>
  <body>
    <div class="video-stage fit-width" id="stage">
      <div class="placeholder" id="placeholder">Ad-Jukebox · Demo</div>
      <img id="image" alt="" />
      <img id="idle-image" alt="" />
      <video id="idle-video" playsinline muted loop></video>
      <video id="video" playsinline></video>
    </div>
    <script>
      const video = document.getElementById("video");
      const placeholder = document.getElementById("placeholder");
      const image = document.getElementById("image");
      const idleVideo = document.getElementById("idle-video");
      const idleImage = document.getElementById("idle-image");
      const stage = document.getElementById("stage");
      let activeUrl = "";
      let imageTimer = null;
      let imageInterval = null;
      let imageState = {
        duration: 0,
        elapsed: 0,
        startAt: 0,
        paused: false,
      };
      let scaleMode = "width";
      let idleCover = null;

      function setPlaceholder(visible) {
        placeholder.style.display = visible ? "grid" : "none";
      }

      function showVideo() {
        video.style.display = "block";
        image.style.display = "none";
        hideIdleCover();
      }

      function showImage() {
        image.style.display = "block";
        video.style.display = "none";
        hideIdleCover();
      }

      function stopVideo() {
        video.pause();
        video.removeAttribute("src");
        video.load();
        activeUrl = "";
        setPlaceholder(true);
        video.style.display = "none";
        image.style.display = "none";
        stopImageTimer();
        updateIdleVisibility();
      }

      function applyScaleMode() {
        if (!stage) return;
        stage.classList.toggle("fit-width", scaleMode === "width");
        stage.classList.toggle("fit-height", scaleMode === "height");
        applyMediaSizing();
        applyIdleSizing();
      }

      function setScaleMode(nextMode) {
        scaleMode = nextMode === "width" ? "width" : "height";
        applyScaleMode();
      }

      function getActiveMedia() {
        if (video.style.display !== "none" && video.src) {
          return { el: video, width: video.videoWidth, height: video.videoHeight };
        }
        if (image.style.display !== "none" && image.src) {
          return { el: image, width: image.naturalWidth, height: image.naturalHeight };
        }
        return null;
      }

      function applyMediaSizing() {
        if (!stage) return;
        const media = getActiveMedia();
        if (!media || !media.width || !media.height) return;
        const stageWidth = stage.clientWidth;
        const stageHeight = stage.clientHeight;
        if (!stageWidth || !stageHeight) return;
        const scale = scaleMode === "width"
          ? Math.max(stageWidth / media.width, stageHeight / media.height)
          : Math.min(stageWidth / media.width, stageHeight / media.height);
        const targetWidth = Math.round(media.width * scale);
        const targetHeight = Math.round(media.height * scale);
        media.el.style.width = `${targetWidth}px`;
        media.el.style.height = `${targetHeight}px`;
      }

      function applyIdleSizing() {
        if (!stage) return;
        const media = getIdleMedia();
        if (!media || !media.width || !media.height) return;
        const stageWidth = stage.clientWidth;
        const stageHeight = stage.clientHeight;
        if (!stageWidth || !stageHeight) return;
        const scale = scaleMode === "width"
          ? Math.max(stageWidth / media.width, stageHeight / media.height)
          : Math.min(stageWidth / media.width, stageHeight / media.height);
        const targetWidth = Math.round(media.width * scale);
        const targetHeight = Math.round(media.height * scale);
        media.el.style.width = `${targetWidth}px`;
        media.el.style.height = `${targetHeight}px`;
      }

      function getIdleMedia() {
        if (idleVideo.style.display !== "none" && idleVideo.src) {
          return { el: idleVideo, width: idleVideo.videoWidth, height: idleVideo.videoHeight };
        }
        if (idleImage.style.display !== "none" && idleImage.src) {
          return { el: idleImage, width: idleImage.naturalWidth, height: idleImage.naturalHeight };
        }
        return null;
      }

      function hideIdleCover() {
        idleVideo.pause();
        idleVideo.removeAttribute("src");
        idleVideo.load();
        idleVideo.style.display = "none";
        idleImage.removeAttribute("src");
        idleImage.style.display = "none";
      }

      function showIdleCover() {
        if (!idleCover?.url) return;
        setPlaceholder(false);
        if (idleCover.kind === "video") {
          idleVideo.src = idleCover.url;
          idleVideo.style.display = "block";
          idleImage.style.display = "none";
          const playPromise = idleVideo.play();
          if (playPromise?.catch) {
            playPromise.catch(() => {});
          }
        } else {
          idleImage.src = idleCover.url;
          idleImage.style.display = "block";
          idleVideo.pause();
          idleVideo.removeAttribute("src");
          idleVideo.load();
          idleVideo.style.display = "none";
        }
        applyIdleSizing();
      }

      function updateIdleVisibility() {
        const hasActiveMedia =
          (video.style.display !== "none" && video.src) ||
          (image.style.display !== "none" && image.src);
        if (hasActiveMedia) {
          hideIdleCover();
          return;
        }
        if (idleCover?.url) {
          showIdleCover();
        } else {
          hideIdleCover();
          setPlaceholder(true);
        }
      }

      function stopImageTimer() {
        if (imageTimer) clearTimeout(imageTimer);
        if (imageInterval) clearInterval(imageInterval);
        imageTimer = null;
        imageInterval = null;
      }

      function startImageTimer() {
        stopImageTimer();
        if (!imageState.duration) return;
        imageState.startAt = Date.now();
        imageTimer = setTimeout(() => {
          imageState.elapsed = imageState.duration;
          if (window.videofonDisplayAPI?.notifyEnded) {
            window.videofonDisplayAPI.notifyEnded();
          }
        }, Math.max(0, (imageState.duration - imageState.elapsed) * 1000));
        imageInterval = setInterval(sendTimeUpdate, 200);
      }

      function playImage(url, duration) {
        if (!url) return;
        stopVideo();
        showImage();
        image.src = url;
        activeUrl = url;
        imageState.duration = Math.max(1, Number(duration) || 1);
        imageState.elapsed = 0;
        imageState.paused = false;
        setPlaceholder(false);
        startImageTimer();
        sendTimeUpdate();
        applyMediaSizing();
      }

      function playVideoUrl(url) {
        if (!url) return;
        stopImageTimer();
        showVideo();
        if (activeUrl !== url) {
          video.pause();
          video.src = url;
          activeUrl = url;
        }
        video.currentTime = 0;
        setPlaceholder(false);
        applyMediaSizing();
        const playPromise = video.play();
        if (playPromise?.catch) {
          playPromise.catch(() => {
            setPlaceholder(true);
          });
        }
      }

      function sendTimeUpdate() {
        if (!window.videofonDisplayAPI?.sendTime) return;
        let duration = 0;
        let current = 0;
        let paused = false;
        if (video.style.display !== "none" && video.src) {
          duration = Number.isFinite(video.duration) ? video.duration : 0;
          current = Number.isFinite(video.currentTime) ? video.currentTime : 0;
          paused = video.paused;
        } else if (image.style.display !== "none" && image.src) {
          duration = imageState.duration || 0;
          const now = Date.now();
          const elapsed = imageState.paused
            ? imageState.elapsed
            : imageState.elapsed + (now - imageState.startAt) / 1000;
          current = Math.min(duration, Math.max(0, elapsed));
          paused = imageState.paused;
        }
        window.videofonDisplayAPI.sendTime({
          currentTime: current,
          duration,
          paused,
        });
      }


      video.addEventListener("timeupdate", sendTimeUpdate);
      video.addEventListener("loadedmetadata", () => {
        sendTimeUpdate();
        applyMediaSizing();
      });
      video.addEventListener("pause", sendTimeUpdate);
      video.addEventListener("play", sendTimeUpdate);
      video.addEventListener("ended", () => {
        if (window.videofonDisplayAPI?.notifyEnded) {
          window.videofonDisplayAPI.notifyEnded();
        }
      });

      if (window.videofonDisplayAPI?.onPlay) {
        window.videofonDisplayAPI.onPlay((payload) => {
          const kind = payload?.kind || "video";
          setScaleMode(payload?.scaleMode);
          if (kind === "image") {
            playImage(payload?.url, payload?.duration);
          } else {
            playVideoUrl(payload?.url);
          }
        });
      }
      if (window.videofonDisplayAPI?.onStop) {
        window.videofonDisplayAPI.onStop(() => stopVideo());
      }
      if (window.videofonDisplayAPI?.onPause) {
        window.videofonDisplayAPI.onPause(() => {
          if (video.style.display !== "none") {
            video.pause();
          } else {
            imageState.paused = true;
            imageState.elapsed = Math.min(
              imageState.duration,
              imageState.elapsed + (Date.now() - imageState.startAt) / 1000
            );
            stopImageTimer();
            sendTimeUpdate();
          }
        });
      }
      if (window.videofonDisplayAPI?.onResume) {
        window.videofonDisplayAPI.onResume(() => {
          if (video.style.display !== "none") {
            const promise = video.play();
            if (promise?.catch) {
              promise.catch(() => setPlaceholder(true));
            }
          } else {
            imageState.paused = false;
            imageState.startAt = Date.now();
            startImageTimer();
            sendTimeUpdate();
          }
        });
      }
      if (window.videofonDisplayAPI?.onSeek) {
        window.videofonDisplayAPI.onSeek((payload) => {
          const nextTime = Number(payload?.time);
          if (Number.isFinite(nextTime)) {
            if (video.style.display !== "none") {
              video.currentTime = Math.max(0, nextTime);
            } else if (image.style.display !== "none") {
              imageState.elapsed = Math.min(Math.max(0, nextTime), imageState.duration);
              imageState.startAt = Date.now();
              if (!imageState.paused) {
                startImageTimer();
              }
              sendTimeUpdate();
            }
          }
        });
      }

      if (window.videofonDisplayAPI?.onScale) {
        window.videofonDisplayAPI.onScale((payload) => {
          setScaleMode(payload?.mode);
        });
      }

      if (window.videofonDisplayAPI?.onIdleCover) {
        window.videofonDisplayAPI.onIdleCover((payload) => {
          const next = payload && payload.url ? payload : null;
          idleCover = next;
          updateIdleVisibility();
        });
      }

      idleVideo.addEventListener("loadedmetadata", applyIdleSizing);
      idleImage.addEventListener("load", applyIdleSizing);
      window.addEventListener("resize", () => {
        applyMediaSizing();
        applyIdleSizing();
      });
      image.addEventListener("load", applyMediaSizing);

      applyScaleMode();
    </script>
  </body>
</html>
